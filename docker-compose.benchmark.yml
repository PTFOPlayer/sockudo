services:
  sockudo-node:
    build:
      context: ./
      dockerfile: ./test/multinode/Dockerfile.multinode
    volumes:
      - ./target:/app/target:ro
      - ./config:/app/config:ro
    environment:
      - DEBUG=false
#      - ADAPTER_DRIVER=local
#      - ADAPTER_REDIS_URL=redis://redis:6380/0
#      - ADAPTER_REDIS_PREFIX="test:"
#      - ADAPTER_REQUEST_TIMEOUT=3000
      - PORT=6003
      - HOST=0.0.0.0
      - METRICS_ENABLED=true
      - METRICS_PORT=9603
#      - APP_MANAGER_DRIVER=memory
#      - CACHE_DRIVER=memory
#      - QUEUE_DRIVER=memory
#      - RATE_LIMITER_DRIVER=memory
#      - SHUTDOWN_GRACE_PERIOD=1
    ports:
      - "6003:6003"
      - "9603:9603"
    networks:
      - sockudo-benchmark-test
    command: ${SOCKUDO_COMMAND:-/app/target/debug/sockudo}
    stdin_open: true
    tty: true
    # Resource limits optimized for memory-only (more resources available)
    deploy:
      resources:
        limits:
          # All resources for Sockudo (no Redis)
          cpus: '8.0'      # Use all available CPU
          memory: 8G       # Use most available memory
        reservations:
          cpus: '4.0'      # Minimum guaranteed CPU
          memory: 4G       # Minimum guaranteed memory

    # System limits optimized for high connection count
    ulimits:
      nofile:
        soft: 65536      # File descriptors for connections
        hard: 65536
      nproc:
        soft: 32768      # Process limit
        hard: 32768

    # Security options for network optimization
    security_opt:
      - no-new-privileges:true

    # Run with higher priority
    privileged: false
    cap_add:
      - NET_ADMIN     # For network optimization
      - SYS_RESOURCE  # For ulimit management

networks:
  sockudo-benchmark-test:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: sockudo0
      com.docker.network.driver.mtu: 1500
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"